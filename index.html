<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>معلم علوم - بکارید و بخورید</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Tahoma', 'Arial', sans-serif;
        }
        body {
            direction: rtl;
            background-color: #f5f7fb;
            color: #333;
            line-height: 1.6;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        .header {
            text-align: center;
            padding: 15px 0;
            margin-bottom: 20px;
            border-bottom: 2px solid #e6e9ef;
            background-color: #e8f5e9;
            border-radius: 12px;
        }
        .header h1 {
            color: #2e7d32;
            font-size: 1.8rem;
        }
        .header p {
            color: #33691e;
            font-size: 1rem;
        }
        .chat-container {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            margin-bottom: 20px;
            background-image: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M50 75C63.8071 75 75 63.8071 75 50C75 36.1929 63.8071 25 50 25C36.1929 25 25 36.1929 25 50C25 63.8071 36.1929 75 50 75Z' fill='%23ffeb3b10'/%3E%3C/svg%3E");
            background-repeat: repeat;
        }
        .message {
            margin-bottom: 15px;
            display: flex;
            align-items: flex-start;
        }
        .message-content {
            max-width: 80%;
            padding: 12px 15px;
            border-radius: 18px;
            font-size: 15px;
            position: relative;
            margin-right: 10px;
            margin-left: 10px;
            white-space: pre-wrap;
        }
        .user { justify-content: flex-end; }
        .bot  { justify-content: flex-start; }
        .user .message-content {
            background-color: #e3f2fd;
            color: #0d47a1;
            border-bottom-left-radius: 5px;
        }
        .bot .message-content {
            background-color: #f0f4c3;
            color: #33691e;
            border-bottom-right-radius: 5px;
        }
        .avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
            background-size: cover;
            background-position: center;
        }
        .bot .avatar {
            background-color: #4caf50;
        }
        .user .avatar {
            background-color: #2196f3;
        }
        .input-container {
            display: flex;
            position: relative;
        }
        #message-input {
            flex: 1;
            padding: 12px 50px 12px 15px;
            border: 2px solid #e6e9ef;
            border-radius: 24px;
            font-size: 15px;
            outline: none;
            transition: border-color 0.3s;
        }
        #message-input:focus {
            border-color: #4a6fa5;
        }
        #send-button {
            position: absolute;
            left: 8px;
            top: 8px;
            width: 36px;
            height: 36px;
            border: none;
            border-radius: 50%;
            background-color: #4caf50;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.3s;
        }
        #send-button:hover { background-color: #388e3c; }
        .typing-indicator {
            display: none;
            padding: 10px;
            margin-bottom: 15px;
        }
        .typing-indicator span {
            height: 8px; width: 8px;
            background-color: #4caf50;
            border-radius: 50%;
            display: inline-block;
            margin: 0 2px;
            animation: bounce 1.4s infinite ease-in-out;
        }
        @keyframes bounce {
            0%, 80%, 100% { transform: translateY(0); }
            40%          { transform: translateY(-8px); }
        }
        .highlight {
            background-color: #fff59d;
            padding: 2px;
            border-radius: 3px;
        }
        @media (max-width: 600px) {
            .container { padding: 10px; }
            .message-content { max-width: 90%; font-size: 14px; }
            .header h1      { font-size: 1.5rem; }
        }
        @keyframes grow {
            0%   { transform: scale(0.95); }
            100% { transform: scale(1); }
        }
        .growing     { animation: grow 2s ease-in-out infinite alternate; }
        .plant-emoji { font-size: 20px; margin: 0 3px; display: inline-block; vertical-align: middle; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>کلاس علوم: بکارید و بخورید</h1>
            <p>
                <span class="plant-emoji growing">🌱</span>
                آزمایش رشد گل آفتابگردان
                <span class="plant-emoji growing">🌻</span>
            </p>
        </div>
        <div class="chat-container" id="chat-container">
            <div class="message bot">
                <div class="avatar"></div>
                <div class="message-content">
                    سلام دانشمند کوچک کلاس پنجمی! 👋 من معلم علوم شما هستم و خیلی خوشحالم که امروز با آزمایش جالب
                    <span class="highlight">رشد گل آفتابگردان</span> از درس «بکارید و بخورید» همراه تو هستم!
                </div>
            </div>
            <div class="typing-indicator" id="typing-indicator">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="input-container">
            <input type="text" id="message-input" placeholder="سوال خود را بپرسید...">
            <button id="send-button">
                🡆
            </button>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const chatContainer = document.getElementById('chat-container');
        const messageInput  = document.getElementById('message-input');
        const sendButton    = document.getElementById('send-button');
        const typingIndicator = document.getElementById('typing-indicator');

        // Groq API configuration
        const GROQ_API_KEY = "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";
        const MODEL         = "meta-llama/llama-4-maverick-17b-128e-instruct";

        // Plant experiment lesson content
        const lessonContent = `سلام دانشمند کوچک کلاس پنجمی! بیا با هم این آزمایش را که از درس "بکارید و بخورید" کتاب علوم است، قدم به قدم و با جزئیات کامل دنبال کنیم...
(… بقیه‌ی متن درس به صورت کامل …)`;

        // **System message with re‑ordered, translated, and emphasized instructions**
        const systemMessage = {
            role: "system",
            content: `You are a fifth-grade science teacher explaining in simple, age-appropriate Persian with a warm, friendly, enthusiastic tone. You use concrete, relatable examples.

In this conversation, you will teach the "Sunflower Planting and Growth" experiment from the "Plant and Eat" science textbook for fifth graders, based strictly on the provided content:

${lessonContent}

Important Points:
1. **STRICTLY PROHIBIT ANY CONTENT OUTSIDE THE PROVIDED MATERIAL. UNDER NO CIRCUMSTANCES SHOULD YOU PROVIDE ANY EXPLANATIONS, EXAMPLES, OR LESSONS THAT GO BEYOND THE SUNFLOWER GROWTH EXPERIMENT. IF A STUDENT ASKS ABOUT ANYTHING OUTSIDE THIS TOPIC, KINDLY BUT FIRMLY REDIRECT THEM BACK AND PROVIDE NO ADDITIONAL EDUCATIONAL CONTENT.**
2. Your responses must be **warm, friendly, and full of energy**.
3. Use affectionate terms like **"little scientist"**, **"my flower"**, **"my dear friend"**.
4. Keep your answers **short, simple, and understandable** for a fifth grader.
5. Use **plant-related emojis** 🌱🌻 to make your responses more engaging.
6. Emphasize that to grow a sunflower properly, one needs **good soil**, **enough water**, and **adequate light**.`
        };

        // Chat history
        let messages = [ systemMessage ];

        // Initial welcome
        messages.push({
            role: "assistant",
            content: `سلام دانشمند کوچک کلاس پنجمی! 👋 من معلم علوم شما هستم و امروز با آزمایش رشد گل آفتابگردان همراه تو هستم! 🌱`
        });

        function addMessageToChat(text, isUser) {
            const div = document.createElement('div');
            div.className = `message ${isUser ? 'user' : 'bot'}`;
            const avatar = document.createElement('div');
            avatar.className = 'avatar';
            const mc = document.createElement('div');
            mc.className = 'message-content';
            mc.innerText = text;
            div.appendChild(avatar);
            div.appendChild(mc);
            chatContainer.insertBefore(div, typingIndicator);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function setTyping(on) {
            typingIndicator.style.display = on ? 'block' : 'none';
            if (on) chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        async function sendMessageToGroq(userText) {
            setTyping(true);
            messages.push({ role: "user", content: userText });
            try {
                const res = await fetch('https://api.groq.com/openai/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${GROQ_API_KEY}`
                    },
                    body: JSON.stringify({
                        model: MODEL,
                        messages: messages,
                        temperature: 0.7,
                        max_tokens: 800,
                        top_p: 0.95
                    })
                });
                const data = await res.json();
                if (!res.ok) throw new Error(data.error?.message);
                let reply = data.choices[0].message.content;
                if (reply.includes("<think>") && reply.includes("</think>")) {
                    reply = reply.substring(reply.lastIndexOf("</think>") + 8).trim();
                }
                messages.push({ role: "assistant", content: reply });
                addMessageToChat(reply, false);
            } catch (e) {
                console.error(e);
                addMessageToChat("متأسفانه مشکلی پیش آمد. لطفاً دوباره تلاش کن! 🌱", false);
            } finally {
                setTyping(false);
            }
        }

        sendButton.addEventListener('click', () => {
            const txt = messageInput.value.trim();
            if (!txt) return;
            addMessageToChat(txt, true);
            messageInput.value = '';
            sendMessageToGroq(txt);
        });

        messageInput.addEventListener('keypress', e => {
            if (e.key === 'Enter' && messageInput.value.trim()) {
                const txt = messageInput.value.trim();
                addMessageToChat(txt, true);
                messageInput.value = '';
                sendMessageToGroq(txt);
            }
        });

        messageInput.focus();
    });
    </script>
</body>
</html>
